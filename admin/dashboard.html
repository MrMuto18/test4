<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ÙÙ„Ø§Ø­ÙŠÙ†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #2d8659;
            --primary-dark: #1e6b45;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: -5px 0 20px var(--shadow);
            z-index: 1000;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .logo-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .logo h1 {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
        }

        .nav-item i {
            font-size: 1.3em;
            margin-left: 15px;
            width: 25px;
        }

        .admin-info {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .admin-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.8em;
            color: var(--primary);
        }

        .logout-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--danger);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            margin-right: 280px;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 2em;
            color: var(--dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .stat-icon.orders { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-icon.products { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .stat-icon.consultations { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .stat-icon.users { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }

        .stat-value {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--dark);
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        /* Content Section */
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px var(--shadow);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .section-header h3 {
            font-size: 1.8em;
            color: var(--dark);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 134, 89, 0.3);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }

        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-processing { background: #d1ecf1; color: #0c5460; }
        .badge-completed { background: #d4edda; color: #155724; }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .loading i {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">ğŸŒ¾</div>
            <h1>ÙÙ„Ø§Ø­ÙŠÙ†</h1>
            <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
        </div>

        <nav>
            <div class="nav-item active" onclick="showSection('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
            </div>
            <div class="nav-item" onclick="window.location.href='products.html'">
                <i class="fas fa-box"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
            </div>
            <div class="nav-item" onclick="window.location.href='questions.html'">
                <i class="fas fa-question-circle"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
            </div>
            <div class="nav-item" onclick="window.location.href='orders.html'">
                <i class="fas fa-shopping-cart"></i>
                <span>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</span>
            </div>
            <div class="nav-item" onclick="showSection('consultations')">
                <i class="fas fa-comments"></i>
                <span>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</span>
            </div>
            <div class="nav-item" onclick="showSection('users')">
                <i class="fas fa-users"></i>
                <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </div>
        </nav>

        <div class="admin-info">
            <div class="admin-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <strong id="adminName">Ø§Ù„Ù…Ø¯ÙŠØ±</strong>
            <p id="adminEmail" style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;"></p>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h2 id="pageTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
            <div>
                <span id="currentDate" style="color: #666;"></span>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon orders">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon products">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-value">9</div>
                    <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon consultations">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-value" id="totalConsultations">0</div>
                    <div class="stat-label">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                </div>
            </div>

            <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px var(--shadow);">
                <h3 style="margin-bottom: 20px; color: var(--dark);">Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</h3>
                <div id="recentOrders"></div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="content-section">
            <div class="section-header">
                <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</h3>
            </div>
            <div id="ordersTable"></div>
        </div>

        <!-- Consultations Section -->
        <div id="consultationsSection" class="content-section">
            <div class="section-header">
                <h3>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</h3>
            </div>
            <div id="consultationsTable"></div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="content-section">
            <div class="section-header">
                <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            </div>
            <div id="usersTable"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-z9igQOo7PbKiTzhi2fIRrHHuUXhN6AU",
            authDomain: "fla7in.firebaseapp.com",
            projectId: "fla7in",
            storageBucket: "fla7in.firebasestorage.app",
            messagingSenderId: "463607450723",
            appId: "1:463607450723:web:04d95f04873d15634bfc56"
        };

        // Initialize Firebase
        let app, auth, db;

        window.addEventListener('load', function() {
            console.log('ğŸš€ ØªØ­Ù…ÙŠÙ„ Dashboard...');
            
            if (typeof firebase === 'undefined') {
                alert('Ø®Ø·Ø£: Firebase ØºÙŠØ± Ù…ØªØ§Ø­!');
                return;
            }

            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('âœ… Firebase Ø¬Ø§Ù‡Ø²!');

                // Check authentication
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„:', user.email);
                        document.getElementById('adminEmail').textContent = user.email;
                        loadDashboardData();
                        setCurrentDate();
                    } else {
                        console.log('âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ - ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
                        window.location.href = '/admin/';
                    }
                });
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Firebase: ' + error.message);
            }
        });

        // Set Current Date
        function setCurrentDate() {
            const date = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = date.toLocaleDateString('ar-TN', options);
        }

        // Logout
        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                auth.signOut().then(function() {
                    window.location.href = '/admin/';
                });
            }
        }

        // Show Section
        function showSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(function(sec) {
                sec.classList.remove('active');
            });

            // Show selected section
            const sectionMap = {
                'dashboard': 'dashboardSection',
                'orders': 'ordersSection',
                'consultations': 'consultationsSection',
                'users': 'usersSection'
            };

            document.getElementById(sectionMap[section]).classList.add('active');

            // Update page title
            const titleMap = {
                'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                'orders': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª',
                'consultations': 'Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª',
                'users': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'
            };

            document.getElementById('pageTitle').textContent = titleMap[section];

            // Load data for section
            if (section === 'orders') loadOrders();
            if (section === 'consultations') loadConsultations();
            if (section === 'users') loadUsers();
        }

        // Load Dashboard Data
        function loadDashboardData() {
            console.log('ğŸ“Š ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            
            // Load Orders Count
            db.collection('orders').get().then(function(snapshot) {
                document.getElementById('totalOrders').textContent = snapshot.size;
                
                const orders = [];
                snapshot.forEach(function(doc) {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                orders.sort(function(a, b) {
                    if (!a.createdAt || !b.createdAt) return 0;
                    // Handle different timestamp formats
                    const aTime = a.createdAt.toMillis ? a.createdAt.toMillis() : 
                                  (a.createdAt.seconds ? a.createdAt.seconds * 1000 : 
                                  new Date(a.createdAt).getTime());
                    const bTime = b.createdAt.toMillis ? b.createdAt.toMillis() : 
                                  (b.createdAt.seconds ? b.createdAt.seconds * 1000 : 
                                  new Date(b.createdAt).getTime());
                    return bTime - aTime;
                });
                displayRecentOrders(orders.slice(0, 5));
            }).catch(function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª:', error);
            });

            // Load Consultations Count
            db.collection('consultations').get().then(function(snapshot) {
                document.getElementById('totalConsultations').textContent = snapshot.size;
            }).catch(function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª:', error);
            });

            // Load Users Count
            db.collection('users').get().then(function(snapshot) {
                document.getElementById('totalUsers').textContent = snapshot.size;
            }).catch(function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
            });
        }

        // Display Recent Orders
        function displayRecentOrders(orders) {
            const container = document.getElementById('recentOrders');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ø¹Ø¯</p></div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
            
            orders.forEach(function(order) {
                const statusClass = 'badge-' + (order.status || 'pending');
                const statusText = {
                    'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                    'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                    'completed': 'Ù…ÙƒØªÙ…Ù„Ø©'
                }[order.status || 'pending'];

                // Handle different date formats
                let date = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (order.createdAt) {
                    try {
                        if (typeof order.createdAt.toDate === 'function') {
                            date = new Date(order.createdAt.toDate()).toLocaleDateString('ar-TN');
                        } else if (order.createdAt.seconds) {
                            date = new Date(order.createdAt.seconds * 1000).toLocaleDateString('ar-TN');
                        } else {
                            date = new Date(order.createdAt).toLocaleDateString('ar-TN');
                        }
                    } catch (e) {
                        date = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    }
                }

                html += '<tr>' +
                    '<td><strong>' + order.customerName + '</strong><br><small>' + order.customerPhone + '</small></td>' +
                    '<td><strong>' + order.total.toFixed(2) + ' Ø¯.Øª</strong></td>' +
                    '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '<td>' + date + '</td>' +
                    '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Load Orders
        function loadOrders() {
            const ordersTable = document.getElementById('ordersTable');
            ordersTable.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            db.collection('orders').orderBy('createdAt', 'desc').get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        ordersTable.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ø¹Ø¯</p></div>';
                        return;
                    }

                    let html = '<table class="data-table"><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
                    
                    snapshot.forEach(function(doc) {
                        const order = doc.data();
                        const statusClass = 'badge-' + (order.status || 'pending');
                        const statusText = {
                            'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                            'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                            'completed': 'Ù…ÙƒØªÙ…Ù„Ø©'
                        }[order.status || 'pending'];

                        // Handle different date formats
                        let date = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        if (order.createdAt) {
                            try {
                                if (typeof order.createdAt.toDate === 'function') {
                                    date = new Date(order.createdAt.toDate()).toLocaleDateString('ar-TN');
                                } else if (order.createdAt.seconds) {
                                    date = new Date(order.createdAt.seconds * 1000).toLocaleDateString('ar-TN');
                                } else {
                                    date = new Date(order.createdAt).toLocaleDateString('ar-TN');
                                }
                            } catch (e) {
                                date = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                            }
                        }

                        html += '<tr>' +
                            '<td><strong>#' + doc.id.substr(0, 8) + '</strong></td>' +
                            '<td><strong>' + order.customerName + '</strong><br><small><i class="fas fa-phone"></i> ' + order.customerPhone + '</small></td>' +
                            '<td>' + order.customerRegion + '</td>' +
                            '<td><strong>' + order.total.toFixed(2) + ' Ø¯.Øª</strong></td>' +
                            '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                            '<td>' + date + '</td>' +
                            '<td><div class="action-buttons">' +
                            '<button class="btn btn-sm btn-warning" onclick="updateOrderStatus(\'' + doc.id + '\', \'processing\')"><i class="fas fa-clock"></i></button>' +
                            '<button class="btn btn-sm btn-success" onclick="updateOrderStatus(\'' + doc.id + '\', \'completed\')"><i class="fas fa-check"></i></button>' +
                            '</div></td>' +
                            '</tr>';
                    });

                    html += '</tbody></table>';
                    ordersTable.innerHTML = html;
                })
                .catch(function(error) {
                    ordersTable.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message + '</p></div>';
                });
        }

        // Update Order Status
        function updateOrderStatus(orderId, status) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŸ')) {
                db.collection('orders').doc(orderId).update({ status: status })
                    .then(function() {
                        alert('ØªÙ…Ù‘ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©!');
                        loadOrders();
                        loadDashboardData();
                    })
                    .catch(function(error) {
                        alert('Ø®Ø·Ø£: ' + error.message);
                    });
            }
        }

        // Load Consultations
        function loadConsultations() {
            const consultationsTable = document.getElementById('consultationsTable');
            consultationsTable.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            db.collection('consultations').orderBy('createdAt', 'desc').get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        consultationsTable.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</p></div>';
                        return;
                    }

                    let html = '<table class="data-table"><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù…Ø­ØµÙˆÙ„</th><th>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
                    
                    snapshot.forEach(function(doc) {
                        const consult = doc.data();
                        const date = consult.createdAt ? new Date(consult.createdAt.toDate()).toLocaleDateString('ar-TN') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                        html += '<tr>' +
                            '<td><strong>' + (consult.userName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</strong><br><small><i class="fas fa-phone"></i> ' + (consult.userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</small></td>' +
                            '<td>' + (consult.crop || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</td>' +
                            '<td>' + (consult.problem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</td>' +
                            '<td>' + date + '</td>' +
                            '</tr>';
                    });

                    html += '</tbody></table>';
                    consultationsTable.innerHTML = html;
                })
                .catch(function(error) {
                    consultationsTable.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message + '</p></div>';
                });
        }

        // Load Users
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            db.collection('users').get()
                .then(function(snapshot) {
                    if (snapshot.empty) {
                        usersTable.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯</p></div>';
                        return;
                    }

                    let html = '<table class="data-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th></tr></thead><tbody>';
                    
                    snapshot.forEach(function(doc) {
                        const user = doc.data();
                        const date = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString('ar-TN') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                        html += '<tr>' +
                            '<td><strong>' + (user.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</strong></td>' +
                            '<td>' + (user.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</td>' +
                            '<td>' + (user.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</td>' +
                            '<td>' + date + '</td>' +
                            '</tr>';
                    });

                    html += '</tbody></table>';
                    usersTable.innerHTML = html;
                })
                .catch(function(error) {
                    usersTable.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message + '</p></div>';
                });
        }
    </script>
</body>
</html>
